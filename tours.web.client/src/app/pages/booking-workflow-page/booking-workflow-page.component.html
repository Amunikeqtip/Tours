<main class="booking-page">
  <section class="section booking-layout">
    <div class="booking-main">
      <div class="steps">
        <article class="step" *ngFor="let label of steps; let idx = index"
          [class.active]="currentStep === idx + 1"
          [class.complete]="currentStep > idx + 1"
          (click)="goToStep(idx + 1)">
          <span>{{ idx + 1 }}</span>
          <p>{{ label }}</p>
        </article>
      </div>

      <section class="panel activity-panel" *ngIf="currentStep === 1">
        <h2><i class="pi pi-info-circle"></i> Activity Details</h2>
        <p class="meta" *ngIf="bookingError"><i class="pi pi-exclamation-triangle"></i> {{ bookingError }}</p>
        <div class="activity-top">
          <div class="activity-main-image" [style.background-image]="'url(' + activity.gallery[0] + ')'"></div>
          <div class="activity-info">
            <p class="badge">{{ activity.subtitle }}</p>
            <h3>{{ activity.title }}</h3>
            <p class="meta"><i class="pi pi-map-marker"></i> {{ activity.location }} <span><i class="pi pi-clock"></i> {{ activity.duration }}</span> <span><i class="pi pi-star-fill"></i> {{ activity.rating }} ({{ activity.reviews }})</span></p>
            <p class="meta" *ngIf="isActivityLoading"><i class="pi pi-spin pi-spinner"></i> Loading live package details...</p>
            <p class="overview">{{ activity.overview }}</p>
            <div class="includes" *ngIf="activity.highlights?.length">
              <h4>Highlights</h4>
              <ul>
                <li *ngFor="let item of activity.highlights"><i class="pi pi-bolt"></i> {{ item }}</li>
              </ul>
            </div>
            <div class="includes">
              <h4>Included</h4>
              <ul>
                <li *ngFor="let item of activity.includes"><i class="pi pi-check-circle"></i> {{ item }}</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="activity-thumbs">
          <img [src]="activity.gallery[1]" alt="activity photo 2" />
          <img [src]="activity.gallery[2]" alt="activity photo 3" />
        </div>
        <div class="itinerary">
          <h4>Itinerary</h4>
          <article *ngFor="let item of itinerary">
            <span>{{ item.time }}</span>
            <div>
              <h5>{{ item.title }}</h5>
              <p>{{ item.description }}</p>
            </div>
          </article>
        </div>
        <div class="itinerary" *ngIf="activity.requirements">
          <h4>Requirements</h4>
          <article>
            <div>
              <p>{{ activity.requirements }}</p>
            </div>
          </article>
        </div>
        <div class="itinerary" *ngIf="activity.attention">
          <h4>Important Notes</h4>
          <article>
            <div>
              <p>{{ activity.attention }}</p>
            </div>
          </article>
        </div>
        <div class="itinerary" *ngIf="activity.cancellation">
          <h4>Cancellation Policy</h4>
          <article>
            <div>
              <p>{{ activity.cancellation }}</p>
            </div>
          </article>
        </div>
      </section>

      <section class="panel" *ngIf="currentStep === 2">
        <h2><i class="pi pi-calendar"></i> Select Date & Time</h2>
        <p class="meta" *ngIf="isAvailabilityLoading"><i class="pi pi-spin pi-spinner"></i> Loading live availability...</p>
        <div class="calendar-controls">
          <label>
            Month
            <select [(ngModel)]="selectedMonth" (ngModelChange)="onMonthYearChange()">
              <option *ngFor="let monthName of monthNames; let idx = index" [ngValue]="idx">{{ monthName }}</option>
            </select>
          </label>
          <label>
            Year
            <select [(ngModel)]="selectedYear" (ngModelChange)="onMonthYearChange()">
              <option *ngFor="let year of yearOptions" [ngValue]="year">{{ year }}</option>
            </select>
          </label>
        </div>
        <div class="days-scroll">
          <div class="days-grid">
          <article class="day" *ngFor="let item of days"
            [class.active]="selectedDate.isoDate === item.isoDate"
            [class.disabled]="item.disabled"
            (click)="selectDate(item)">
            <span>{{ item.day }}</span>
            <strong>{{ item.date }}</strong>
            <small>{{ item.month }}</small>
          </article>
          </div>
        </div>

        <h2><i class="pi pi-clock"></i> Select Start Time</h2>
        <div class="time-select-row">
          <div class="time-grid">
            <button type="button" class="time" *ngFor="let time of timeOptions"
              [class.active]="selectedTime === time"
              (click)="selectTime(time)">
              {{ time }}
            </button>
          </div>
          <label class="custom-time" *ngIf="!isAvailabilityLoading && !selectedAvailabilitySlot && !timeOptions.length">
            No live slots found in this month. Try another month.
          </label>
          <label class="custom-time" *ngIf="!bokunPackageId">
            Pick exact time
            <input type="time" [ngModel]="selectedTimeInput" (ngModelChange)="onTimeInputChange($event)" />
          </label>
        </div>
        <p class="time-empty" *ngIf="timeOptions.length === 0">No remaining slots for this date. Please choose another date.</p>
      </section>

      <section class="panel" *ngIf="currentStep === 2">
        <h2><i class="pi pi-users"></i> Number of Guests</h2>
        <div class="guests-grid">
          <article>
            <h3>Adults</h3>
            <p>Ages 13+</p>
            <small>${{ adultPrice }} per person</small>
            <div class="counter">
              <button type="button" (click)="adjustAdults(-1)">-</button>
              <strong>{{ adults }}</strong>
              <button type="button" (click)="adjustAdults(1)">+</button>
            </div>
          </article>
          <article>
            <h3>Children</h3>
            <p>Ages 3-12</p>
            <small>${{ childPrice }} per child</small>
            <div class="counter">
              <button type="button" (click)="adjustChildren(-1)">-</button>
              <strong>{{ children }}</strong>
              <button type="button" (click)="adjustChildren(1)">+</button>
            </div>
          </article>
        </div>
      </section>

      <section class="panel" *ngIf="currentStep === 3">
        <h2><i class="pi pi-user-edit"></i> Passenger Details</h2>
        <p class="meta" *ngIf="checkoutMessage">{{ checkoutMessage }}</p>
        <div class="form-grid">
          <label>
            Full Name
            <input type="text" [(ngModel)]="fullName" />
          </label>
          <label>
            Email Address
            <input type="email" [(ngModel)]="email" />
          </label>
          <label>
            Phone Number
            <input type="text" [(ngModel)]="phone" placeholder="+263771234567" />
            <small class="form-hint" *ngIf="phone.trim().length">Will be sent as: {{ normalizedPhone }}</small>
            <small class="form-error" *ngIf="phone.trim().length && !isPhoneValid">Use 7-15 digits, optionally starting with +.</small>
          </label>
          <label>
            Personal ID / Passport
            <input type="text" [(ngModel)]="personalIdNumber" />
          </label>
          <label>
            Nationality (2-letter code)
            <input type="text" [(ngModel)]="nationality" placeholder="ZW" />
          </label>
          <label>
            Notes
            <textarea rows="4" [(ngModel)]="notes"></textarea>
          </label>
        </div>
      </section>

      <section class="panel" *ngIf="currentStep === 4">
        <h2><i class="pi pi-credit-card"></i> Payment</h2>
        <p class="meta" *ngIf="bookingError"><i class="pi pi-exclamation-triangle"></i> {{ bookingError }}</p>
        <p class="meta" *ngIf="isCheckoutLoading"><i class="pi pi-spin pi-spinner"></i> Submitting checkout...</p>
        <div class="form-grid" *ngIf="bokunPackageId">
          <label>
            Checkout Option
            <select [(ngModel)]="selectedCheckoutOption" (ngModelChange)="onCheckoutOptionChange()">
              <option *ngFor="let option of checkoutOptions" [value]="option.type">{{ option.label || formatCheckoutOption(option.type) }} ({{ formatMoney(option.amount, option.currency) }})</option>
            </select>
          </label>
          <label>
            Payment Method
            <select [(ngModel)]="selectedPaymentMethod">
              <option *ngFor="let method of selectedOptionPaymentMethods" [value]="method">{{ formatPaymentMethod(method) }}</option>
            </select>
          </label>
        </div>
        <p class="meta" *ngIf="bokunPackageId && selectedCheckoutOption">
          Selected: <strong>{{ formatCheckoutOption(selectedCheckoutOption) }}</strong>
        </p>
        <p class="meta" *ngIf="bokunPackageId && selectedPaymentMethod">
          Method: <strong>{{ formatPaymentMethod(selectedPaymentMethod) }}</strong>
        </p>
        <div class="form-grid" *ngIf="!bokunPackageId || isCardPaymentSelected">
          <label>
            Name on Card
            <input type="text" [(ngModel)]="cardName" autocomplete="cc-name" placeholder="John Doe" />
            <small class="form-error" *ngIf="cardName.trim().length && !isCardNameValid">Enter cardholder name.</small>
          </label>
          <label>
            Card Number
            <input type="text" [(ngModel)]="cardNumber" autocomplete="cc-number" placeholder="4111 1111 1111 1111" />
            <small class="form-error" *ngIf="cardNumber.trim().length && !isCardNumberValid">Use 12 to 19 digits.</small>
          </label>
          <label>
            Expiry (MM/YY)
            <input type="text" [(ngModel)]="expiry" autocomplete="cc-exp" placeholder="08/28" />
            <small class="form-error" *ngIf="expiry.trim().length && !isExpiryValid">Use MM/YY format.</small>
          </label>
          <label>
            CVV
            <input type="password" [(ngModel)]="cvv" autocomplete="cc-csc" placeholder="123" />
            <small class="form-error" *ngIf="cvv.trim().length && !isCvvValid">Use 3 or 4 digits.</small>
          </label>
        </div>
        <p class="meta" *ngIf="bokunPackageId && !isCardPaymentSelected">
          Card details are not required for {{ formatPaymentMethod(selectedPaymentMethod) || 'this payment method' }}.
        </p>
      </section>

      <section class="panel" *ngIf="currentStep === 5">
        <h2><i class="pi pi-check-circle"></i> Confirmation</h2>
        <p class="confirm-text">Your booking has been captured and is ready for final processing.</p>
        <p class="confirm-text" *ngIf="bookingConfirmationCode">Confirmation code: <strong>{{ bookingConfirmationCode }}</strong></p>
        <p class="confirm-text" *ngIf="bookingReference">Booking reference: <strong>{{ bookingReference }}</strong></p>
        <div class="confirm-grid">
          <p><span>Date:</span> <strong>{{ selectedDate.day }}, {{ selectedDate.month }} {{ selectedDate.date }}</strong></p>
          <p><span>Time:</span> <strong>{{ selectedTime }}</strong></p>
          <p><span>Guests:</span> <strong>{{ guestLabel }}</strong></p>
          <p><span>Primary Guest:</span> <strong>{{ fullName || 'N/A' }}</strong></p>
        </div>
      </section>

      <div class="actions">
        <button type="button" class="prev-btn" (click)="previousStep()" [disabled]="currentStep === 1">Back</button>
        <button type="button" class="next-btn" *ngIf="currentStep < steps.length"
          [disabled]="!canMoveNext" (click)="nextStep()">
          {{ currentStep === 4 ? 'Submit Booking' : 'Next Step' }} <i class="pi pi-angle-right"></i>
        </button>
        <button type="button" class="next-btn" *ngIf="currentStep === steps.length" routerLink="/">
          Finish & Return Home <i class="pi pi-home"></i>
        </button>
      </div>
    </div>

    <aside class="booking-side">
      <section class="summary-card">
        <div class="tour-head">
          <img [src]="activity.gallery[0]" alt="tour preview" />
          <div>
            <p>{{ activity.subtitle }}</p>
            <h3>{{ activity.title }}</h3>
            <span><i class="pi pi-map-marker"></i> {{ activity.location }}</span>
          </div>
        </div>
        <div class="tour-meta">
          <p><span>Date</span> <strong>{{ selectedDate.month }} {{ selectedDate.date }}, {{ selectedDate.day }}</strong></p>
          <p><span>Guests</span> <strong>{{ guestLabel }}</strong></p>
          <p><span>Start Time</span> <strong>{{ selectedTime }}</strong></p>
        </div>
        <div class="total">
          <p>Total (USD)</p>
          <h4>${{ total }}</h4>
          <small>Subtotal ${{ subtotal }} + fees ${{ bookingFee }}</small>
        </div>
      </section>

      <section class="trust-card">
        <h4>Why Book With Us?</h4>
        <p><i class="pi pi-check-circle"></i> Free cancellation up to 24h before</p>
        <p><i class="pi pi-check-circle"></i> Instant booking confirmation</p>
        <p><i class="pi pi-check-circle"></i> Certified local guides</p>
        <p><i class="pi pi-check-circle"></i> No hidden booking fees</p>
      </section>
    </aside>
  </section>
</main>
